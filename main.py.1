#!/usr/bin/env python3
"""
Project Outline System - Main Launcher
"""

import os
import sys
import subprocess
from project_state import get_active_project

# ANSI Color codes
class Colors:
    RESET = '\033[0m'
    BOLD = '\033[1m'
    DIM = '\033[2m'
    
    RED = '\033[31m'
    GREEN = '\033[32m'
    YELLOW = '\033[33m'
    BLUE = '\033[34m'
    CYAN = '\033[36m'
    
    BRIGHT_BLACK = '\033[90m'
    BRIGHT_GREEN = '\033[92m'
    BRIGHT_YELLOW = '\033[93m'
    BRIGHT_BLUE = '\033[94m'
    BRIGHT_CYAN = '\033[96m'
    BRIGHT_WHITE = '\033[97m'
    
    BG_BLUE = '\033[44m'
    BG_CYAN = '\033[46m'


def clear_screen():
    """Clear the terminal screen"""
    os.system('clear' if os.name != 'nt' else 'cls')


def get_terminal_size():
    """Get terminal size (rows, columns)"""
    try:
        size = os.get_terminal_size()
        return size.lines, size.columns
    except:
        return 24, 80


def print_header():
    """Print application header"""
    rows, cols = get_terminal_size()
    
    clear_screen()
    print()
    print(f"{Colors.BG_BLUE}{Colors.BRIGHT_WHITE}{Colors.BOLD}" + " " * cols + f"{Colors.RESET}")
    
    title = "  PROJECT OUTLINE SYSTEM"
    padding = " " * (cols - len(title))
    print(f"{Colors.BG_BLUE}{Colors.BRIGHT_WHITE}{Colors.BOLD}{title}{padding}{Colors.RESET}")
    
    print(f"{Colors.BG_BLUE}{Colors.BRIGHT_WHITE}{Colors.BOLD}" + " " * cols + f"{Colors.RESET}")
    print()


def print_menu():
    """Print main menu"""
    print(f"{Colors.BOLD}{Colors.BRIGHT_CYAN}Available Tools:{Colors.RESET}\n")
    
    print(f"  {Colors.BRIGHT_YELLOW}1{Colors.RESET}. {Colors.BRIGHT_WHITE}Outline Editor{Colors.RESET}")
    print(f"     {Colors.DIM}Modern word-processor style editor with color-coded interface{Colors.RESET}")
    print(f"     {Colors.DIM}Best for: Writing and editing content interactively{Colors.RESET}\n")
    
    print(f"  {Colors.BRIGHT_YELLOW}2{Colors.RESET}. {Colors.BRIGHT_WHITE}Project Manager{Colors.RESET}")
    print(f"     {Colors.DIM}Select and manage projects - sets active project for Editor{Colors.RESET}")
    print(f"     {Colors.DIM}Best for: Creating and organizing multiple projects{Colors.RESET}\n")
    
    print(f"  {Colors.BRIGHT_YELLOW}3{Colors.RESET}. {Colors.BRIGHT_WHITE}Export to Text{Colors.RESET}")
    print(f"     {Colors.DIM}Export any project to a plain text file{Colors.RESET}")
    print(f"     {Colors.DIM}Best for: Sharing or backing up your work{Colors.RESET}\n")
    
    print(f"  {Colors.BRIGHT_YELLOW}Q{Colors.RESET}. {Colors.BRIGHT_BLACK}Quit{Colors.RESET}\n")


def launch_outline_editor():
    """Launch the outline editor"""
    try:
        subprocess.run([sys.executable, "outline_editor.py"])
    except FileNotFoundError:
        print(f"\n{Colors.RED}Error:{Colors.RESET} outline_editor.py not found in current directory")
    except Exception as e:
        print(f"\n{Colors.RED}Error:{Colors.RESET} {e}")


def launch_project_manager():
    """Launch the project manager"""
    try:
        subprocess.run([sys.executable, "project_outline_manager.py"])
    except FileNotFoundError:
        print(f"\n{Colors.RED}Error:{Colors.RESET} project_outline_manager.py not found in current directory")
    except Exception as e:
        print(f"\n{Colors.RED}Error:{Colors.RESET} {e}")


def launch_export():
    """Launch the export tool"""
    try:
        subprocess.run([sys.executable, "export_to_text.py"])
    except FileNotFoundError:
        print(f"\n{Colors.RED}Error:{Colors.RESET} export_to_text.py not found in current directory")
    except Exception as e:
        print(f"\n{Colors.RED}Error:{Colors.RESET} {e}")


def show_info():
    """Show information about the database and active project"""
    db_file = "project_outlines.db"
    
    rows, cols = get_terminal_size()
    print(f"{Colors.BRIGHT_BLACK}{'─' * cols}{Colors.RESET}")
    
    # Show database info
    if os.path.exists(db_file):
        size = os.path.getsize(db_file)
        size_kb = size / 1024
        print(f"{Colors.DIM}Database: {db_file} ({size_kb:.1f} KB){Colors.RESET}")
    else:
        print(f"{Colors.DIM}No database found - a new one will be created on first use{Colors.RESET}")
    
    # Show active project
    active_id, active_name = get_active_project()
    if active_id and active_name:
        print(f"{Colors.GREEN}Active Project:{Colors.RESET} {Colors.BRIGHT_CYAN}{active_name}{Colors.RESET} {Colors.DIM}(ID: {active_id}){Colors.RESET}")
    else:
        print(f"{Colors.DIM}No active project - use Project Manager to select one{Colors.RESET}")
    
    print(f"{Colors.BRIGHT_BLACK}{'─' * cols}{Colors.RESET}")


def main():
    """Main application loop"""
    while True:
        print_header()
        print_menu()
        show_info()
        
        choice = input(f"\n{Colors.BRIGHT_GREEN}Select an option (1-3, Q):{Colors.RESET} ").strip().upper()
        
        if choice == '1':
            clear_screen()
            launch_outline_editor()
        elif choice == '2':
            clear_screen()
            launch_project_manager()
        elif choice == '3':
            clear_screen()
            launch_export()
        elif choice == 'Q':
            clear_screen()
            print(f"\n{Colors.BRIGHT_CYAN}Thank you for using Project Outline System!{Colors.RESET}\n")
            break
        else:
            print(f"\n{Colors.RED}Invalid choice.{Colors.RESET} Please select 1, 2, 3, or Q.")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        clear_screen()
        print(f"\n{Colors.BRIGHT_CYAN}Goodbye!{Colors.RESET}\n")
        sys.exit(0)
    except Exception as e:
        print(f"\n{Colors.RED}Error:{Colors.RESET} {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
